function Step(){if(bIsDirty&&Compile(),bIsReset=!1,"halt"==sState.substring(0,4).toLowerCase()||"stop"==sState.substring(0,4).toLowerCase())return SetStatusMessage("Arrêté."),notifyUser("Arrêté."),EnableControls(!1,!1,!1,!0,!0,!0,!0),!1;var e,t,a,n,r=GetTapeSymbol(nHeadPosition),s=GetNextInstruction(sState,r);return null!=s?(e="*"==s.newState?sState:s.newState,t="*"==s.newSymbol?r:s.newSymbol,a="r"==s.action.toLowerCase()?1:"l"==s.action.toLowerCase()?-1:0,1==nVariant&&0==nHeadPosition&&-1==a&&(a=0),n=s.sourceLineNumber):(debug(1,"Warning: no instruction found for state '"+sState+"' symbol '"+r+"'; halting"),SetStatusMessage("Arrêté. Aucune règle pour l'état '"+sState+"' et le symbole '"+r+"'.",2),notifyUser("Arrêté. Aucune règle pour l'état '"+sState+"' et le symbole '"+r+"'.",2),e="halt",t=r,a=0,n=-1),nMaxUndo>0&&(aUndoList.length>=nMaxUndo&&aUndoList.shift(),aUndoList.push({state:sState,position:nHeadPosition,symbol:r})),SetTapeSymbol(nHeadPosition,t),sState=e,nHeadPosition+=a,nSteps++,oPrevInstruction=s,oNextInstruction=GetNextInstruction(e,GetTapeSymbol(nHeadPosition)),debug(4,"Step() finished. New tape: '"+sTape+"'  new state: '"+sState+"'  action: "+a+"  line number: "+n),UpdateInterface(),"halt"==e.substring(0,4).toLowerCase()?(null!=s&&(SetStatusMessage("Arrêté."),notifyUser("Arrêté.")),EnableControls(!1,!1,!1,!0,!0,!0,!0),!1):s.breakpoint?(SetStatusMessage("Stoppé au point d'arrêt à la ligne "+(n+1)),notifyUser("Stoppé au point d'arrêt à la ligne "+(n+1)),EnableControls(!0,!0,!1,!0,!0,!0,!0),!1):!0}function Undo(){var e=aUndoList.pop();e?(nSteps--,sState=e.state,nHeadPosition=e.position,SetTapeSymbol(nHeadPosition,e.symbol),oPrevInstruction=null,oNextInstruction=GetNextInstruction(sState,e.symbol),debug(3,"Undone one step. New state: '"+sState+"' position : "+nHeadPosition+" symbol: '"+e.symbol+"'"),EnableControls(!0,!0,!1,!0,!0,!0,!0),SetStatusMessage("Une étape annulée."),UpdateInterface()):debug(1,"Warning: Tried to undo with no undo data available!")}function Run(){var e=!0;if(bFullSpeed){for(var t=0;e&&25>t;t++)e=Step();e?hRunTimer=window.setTimeout(Run,10):UpdateInterface()}else Step()&&(hRunTimer=window.setTimeout(Run,50))}function RunStep(){Step()||StopTimer()}function StopTimer(){null!=hRunTimer&&(window.clearInterval(hRunTimer),hRunTimer=null)}function Reset(){var e=$("#InitialInput")[0].value;nHeadPosition=e.indexOf("*"),-1==nHeadPosition&&(nHeadPosition=0),e=e.replace(/\*/g,"").replace(/ /g,"_"),""==e&&(e=" "),sTape=e,nTapeOffset=0;var t=$("#InitialState")[0].value;t=$.trim(t).split(/\s+/)[0],t&&""!=t||(t="q0"),sState=t;var a=$("#MachineVariant")[0];nVariant=Number(a.options[a.selectedIndex].value),SetupVariantCSS(),nSteps=0,bIsReset=!0,Compile(),oPrevInstruction=null,oNextInstruction=GetNextInstruction(sState,GetTapeSymbol(nHeadPosition)),aUndoList=[],EnableControls(!0,!0,!1,!0,!0,!0,!1),UpdateInterface()}function Compile(){var e=oTextarea.value;debug(2,"Compile()"),SetSyntaxMessage(null),ClearErrorLines(),aProgram=new Object,e=e.replace(/\r/g,"");for(var t=e.split("\n"),a=0;a<t.length;a++){var n=ParseLine(t[a],a);n.isValid?(debug(5," Parsed tuple: '"+n.currentState+"'  '"+n.currentSymbol+"'  '"+n.newSymbol+"'  '"+n.action+"'  '"+n.newState+"'"),null==aProgram[n.currentState]&&(aProgram[n.currentState]=new Object),null!=aProgram[n.currentState][n.currentSymbol]&&(debug(1,"Warning: multiple definitions for state '"+n.currentState+"' symbol '"+n.currentSymbol+"' on lines "+(aProgram[n.currentState][n.currentSymbol].sourceLineNumber+1)+" and "+(a+1)),SetSyntaxMessage("Attention : plusieurs transitions définies pour l'état '"+n.currentState+"' et le symbole '"+n.currentSymbol+"', aux lignes "+(aProgram[n.currentState][n.currentSymbol].sourceLineNumber+1)+" et "+(a+1)+"."),SetErrorLine(a),SetErrorLine(aProgram[n.currentState][n.currentSymbol].sourceLineNumber)),aProgram[n.currentState][n.currentSymbol]=new Object,aProgram[n.currentState][n.currentSymbol].newSymbol=n.newSymbol,aProgram[n.currentState][n.currentSymbol].action=n.action,aProgram[n.currentState][n.currentSymbol].newState=n.newState,aProgram[n.currentState][n.currentSymbol].sourceLineNumber=a,aProgram[n.currentState][n.currentSymbol].breakpoint=n.breakpoint):n.error&&(debug(2,"Syntax error: "+n.error),SetSyntaxMessage(n.error),SetErrorLine(a))}if(oRegExp=new RegExp(";.*\\$DEBUG: *(.+)"),aResult=oRegExp.exec(e),null!=aResult&&aResult.length>=2){var r=parseInt(aResult[1]);r!=nDebugLevel&&(nDebugLevel=parseInt(aResult[1]),debug(1,"Setting debug level to "+nDebugLevel),nDebugLevel>0&&$(".DebugClass").toggle(!0))}oPrevInstruction=null,oNextInstruction=GetNextInstruction(sState,GetTapeSymbol(nHeadPosition)),bIsDirty=!1,UpdateInterface()}function ParseLine(e,t){debug(5,"ParseLine( "+e+" )"),e=e.split(";",1)[0];var a=e.split(/\s+/);a=a.filter(function(e){return""!=e});var n=new Object;if(0==a.length)return n.isValid=!1,n;if(n.currentState=a[0],a.length<2)return n.isValid=!1,n.error="Erreur de syntaxe à la ligne "+(t+1)+": il manque &lt;le symbole courant&gt; !",n;if(a[1].length>1)return n.isValid=!1,n.error="Erreur de syntaxe à la ligne "+(t+1)+": &lt;le symbole courant&gt; devrait être UN SEUL symbole !",n;if(n.currentSymbol=a[1],a.length<3)return n.isValid=!1,n.error="Erreur de syntaxe à la ligne "+(t+1)+": il manque &lt;le nouveau symbole&gt;!",n;if(a[2].length>1)return n.isValid=!1,n.error="Erreur de syntaxe à la ligne "+(t+1)+": &lt;le nouveau symbole&gt; devrait être UN SEUL symbole !",n;if(n.newSymbol=a[2],a.length<4)return n.isValid=!1,n.error="Erreur de syntaxe à la ligne "+(t+1)+": il manque &lt;la direction&gt;!",n;if(["l","r","*"].indexOf(a[3].toLowerCase())<0)return n.isValid=!1,n.error="Erreur de syntaxe à la ligne "+(t+1)+": &lt;la direction&gt; doit être 'l' (pour gauche), ou 'r' (pour droite) ou '*' (pour rester sur place) !",n;if(n.action=a[3].toLowerCase(),a.length<5)return n.isValid=!1,n.error="Erreur de syntaxe à la ligne "+(t+1)+": il manque &lt;le nouveau état&gt;!",n;if(n.newState=a[4],a.length>6)return n.isValid=!1,n.error="Erreur de syntaxe à la ligne "+(t+1)+": trop de valeurs sur cette ligne (il faut 5 ou 6 valeurs) !",n;if(6==a.length){if("!"!=a[5])return n.isValid=!1,n.error="Erreur de syntaxe à la ligne "+(t+1)+": trop de valeurs sur cette ligne (seul un ! est autorisé en 6ème position) !",n;n.breakpoint=!0}else n.breakpoint=!1;return n.isValid=!0,n}function GetNextInstruction(e,t){return null!=aProgram[e]&&null!=aProgram[e][t]?aProgram[e][t]:null!=aProgram[e]&&null!=aProgram[e]["*"]?aProgram[e]["*"]:null!=aProgram["*"]&&null!=aProgram["*"][t]?aProgram["*"][t]:null!=aProgram["*"]&&null!=aProgram["*"]["*"]?aProgram["*"]["*"]:null}function GetTapeSymbol(e){if(nTapeOffset>e||e>=sTape.length+nTapeOffset)return debug(4,"GetTapeSymbol( "+e+" ) = '"+t+"'   outside sTape range"),"_";var t=sTape.charAt(e-nTapeOffset);return" "==t&&(t="_",debug(4,"Warning: GetTapeSymbol() got SPACE not _ !")),debug(4,"GetTapeSymbol( "+e+" ) = '"+t+"'"),t}function SetTapeSymbol(e,t){debug(4,"SetTapeSymbol( "+e+", "+t+" ); sTape = '"+sTape+"' nTapeOffset = "+nTapeOffset)," "==t&&(t="_",debug(4,"Warning: SetTapeSymbol() with SPACE not _ !")),nTapeOffset>e?(sTape=t+repeat("_",nTapeOffset-e-1)+sTape,nTapeOffset=e):sTape=e>nTapeOffset+sTape.length?sTape+repeat("_",nTapeOffset+sTape.length-e-1)+t:sTape.substr(0,e-nTapeOffset)+t+sTape.substr(e-nTapeOffset+1)}function SaveMachineSnapshot(){return{program:oTextarea.value,state:sState,tape:sTape,tapeoffset:nTapeOffset,headposition:nHeadPosition,steps:nSteps,initialtape:$("#InitialInput")[0].value,initialstate:$("#InitialState")[0].value,fullspeed:bFullSpeed,variant:nVariant,version:1}}function LoadMachineSnapshot(e){e.version&&1!=e.version&&debug(1,"Warning: saved machine has unknown version number "+e.version),e.program&&(oTextarea.value=e.program),e.state&&(sState=e.state),e.tape&&(sTape=e.tape),e.tapeoffset&&(nTapeOffset=e.tapeoffset),e.headposition&&(nHeadPosition=e.headposition),e.steps&&(nSteps=e.steps),e.initialtape&&($("#InitialInput")[0].value=e.initialtape),e.initialstate?$("#InitialState")[0].value=e.initialstate:$("#InitialState")[0].value="",e.fullspeed&&($("#SpeedCheckbox")[0].checked=e.fullspeed,bFullSpeed=e.fullspeed),nVariant=e.variant?e.variant:0,$("#MachineVariant").val(nVariant),VariantChanged(),SetupVariantCSS(),aUndoList=[],"halt"==sState.substring(0,4).toLowerCase()?(SetStatusMessage("Machine chargée. Arrêtée.",1),notifyUser("Machine chargée. Arrêtée.",1),EnableControls(!1,!1,!1,!0,!0,!0,!0)):(SetStatusMessage("Machine chargée et prête.",1),notifyUser("Machine chargée et prête.",1),EnableControls(!0,!0,!1,!0,!0,!0,!0)),TextareaChanged(),Compile(),UpdateInterface()}function SetStatusMessage(e,t){$("#MachineStatusMsgText").html(e),t>0&&$("#MachineStatusMsgBg").stop(!0,!0).css("background-color",1==t?"#c9f2c9":"#ffb3b3").show().fadeOut(600),""!=e&&sPreviousStatusMsg==e&&-1!=t&&$("#MachineStatusMsgBg").stop(!0,!0).css("background-color","#bbf8ff").show().fadeOut(600),""!=e&&(sPreviousStatusMsg=e)}function SetSyntaxMessage(e){$("#SyntaxMsg").html(e?e:"&nbsp;")}function RenderTape(){var e,t,a,n=nHeadPosition-nTapeOffset;debug(4,"RenderTape: translated head pos: "+n+"  head pos: "+nHeadPosition+"  tape offset: "+nTapeOffset),debug(4,"RenderTape: sTape = '"+sTape+"'"),e=n>0?sTape.substr(0,n):"",n>sTape.length&&(e+=repeat(" ",n-sTape.length)),e=e.replace(/_/g," "),t=n>=0&&n<sTape.length?sTape.charAt(n):" ",t=t.replace(/_/g," "),a=n>=0&&n<sTape.length-1?sTape.substr(n+1):0>n?repeat(" ",-n-1)+sTape:"",a=a.replace(/_/g," "),debug(4,"RenderTape: sFirstPart = '"+e+"' sHeadSymbol = '"+t+"'  sSecondPart = '"+a+"'"),$("#LeftTape").text(e),$("#ActiveTape").text(t),$("#RightTape").text(a),$("#ActiveTapeArea").position().left<0?$("#MachineTape").scrollLeft($("#MachineTape").scrollLeft()+$("#ActiveTapeArea").position().left-10):$("#ActiveTapeArea").position().left+$("#ActiveTapeArea").width()>$("#MachineTape").width()&&$("#MachineTape").scrollLeft($("#MachineTape").scrollLeft()+($("#ActiveTapeArea").position().left-$("#MachineTape").width())+10)}function RenderState(){$("#MachineState").html(sState)}function RenderSteps(){$("#MachineSteps").html(nSteps)}function RenderLineMarkers(){debug(3,"Rendering line markers: "+(oNextInstruction?oNextInstruction.sourceLineNumber:-1)+" "+(oPrevInstruction?oPrevInstruction.sourceLineNumber:-1)),SetActiveLines(oNextInstruction?oNextInstruction.sourceLineNumber:-1,oPrevInstruction?oPrevInstruction.sourceLineNumber:-1)}function UpdateInterface(){RenderTape(),RenderState(),RenderSteps(),RenderLineMarkers()}function ClearDebug(){$("#debug").empty()}function EnableControls(e,t,a,n,r,s,o){document.getElementById("StepButton").disabled=!e,document.getElementById("RunButton").disabled=!t,document.getElementById("StopButton").disabled=!a,document.getElementById("ResetButton").disabled=!n,document.getElementById("SpeedCheckbox").disabled=!r,document.getElementById("Source").disabled=!s,EnableUndoButton(o),r?$("#SpeedCheckboxLabel").removeClass("disabled"):$("#SpeedCheckboxLabel").addClass("disabled")}function EnableUndoButton(e){document.getElementById("UndoButton").disabled=!(e&&aUndoList.length>0)}function StepButton(){SetStatusMessage("",-1),Step(),EnableUndoButton(!0)}function RunButton(){SetStatusMessage("Calcul en cours..."),SpeedCheckbox(),EnableControls(!1,!1,!0,!1,!1,!1,!1),Run()}function StopButton(){null!=hRunTimer&&(SetStatusMessage("Pausé; cliquez 'Lancer' ou 'Étape' pour continuer."),notifyUser("Pausé; cliquez 'Lancer' ou 'Étape' pour continuer."),EnableControls(!0,!0,!1,!0,!0,!0,!0),StopTimer())}function ResetButton(){SetStatusMessage("Machine réinitialisée. Cliquez 'Lancer' ou 'Étape' pour commencer."),notifyUser("Machine réinitialisée. Cliquez 'Lancer' ou 'Étape' pour commencer."),Reset(),EnableControls(!0,!0,!1,!0,!0,!0,!1)}function SpeedCheckbox(){bFullSpeed=$("#SpeedCheckbox")[0].checked}function VariantChanged(){var e=$("#MachineVariant")[0];selected=Number(e.options[e.selectedIndex].value);var t={0:"Machine de Turing standard, avec un ruban infini dans les deux directions.",1:"Machine de Turing avec un ruban infini dans seulement une direction (utilisée et décrite notamment dans le livre par <a href='http://math.mit.edu/~sipser/book.html'>Michael Sipser</a>)."};$("#MachineVariantDescription").html(t[selected])}function SetupVariantCSS(){1==nVariant?$("#LeftTape").addClass("OneDirectionalTape"):$("#LeftTape").removeClass("OneDirectionalTape")}function LoadFromCloud(e){$.ajax({url:"https://api.github.com/gists/"+e,type:"GET",dataType:"json",success:loadSuccessCallback,error:loadErrorCallback})}function loadSuccessCallback(e){if(!(e&&e.files&&e.files["machine.json"]&&e.files["machine.json"].content))return debug(1,"Error: Load AJAX request succeeded but can't find expected data."),SetStatusMessage("Erreur lors du chargement de la machine sauvegardée :( :(",2),void notifyUser("Erreur lors du chargement de la machine sauvegardée :( :(",2);var t;try{t=JSON.parse(e.files["machine.json"].content)}catch(a){return debug(1,"Error: Exception when unpacking JSON: "+a),SetStatusMessage("Erreur lors du chargement de la machine sauvegardée :( :(",2),void notifyUser("Erreur lors du chargement de la machine sauvegardée :( :(",2)}LoadMachineSnapshot(t)}function loadErrorCallback(e,t,a){debug(1,"Error: Load failed. AJAX request to Github failed. HTTP response "+a),SetStatusMessage("Erreur lors du chargement de la machine sauvegardée :( :(",2),notifyUser("Erreur lors du chargement de la machine sauvegardée :( :(",2)}function SaveToCloud(){SetSaveMessage("Saving...",null);var e=SaveMachineSnapshot(),t={description:"État d'une machine de Turing machine sauvegardé depuis https://naereen.github.io/jsTuring_fr/turing.html","public":!1,files:{"machine.json":{content:JSON.stringify(e)}}};$.ajax({url:"https://api.github.com/gists",type:"POST",data:JSON.stringify(t),dataType:"json",contentType:"application/json; charset=utf-8",success:saveSuccessCallback,error:saveErrorCallback})}function saveSuccessCallback(e){if(e&&e.id){var t=window.location.href.replace(/[\#\?].*/,"");t+="?"+e.id,debug(1,"Save successful. Gist ID is "+e.id+" Gist URL is "+e.url);var a=new Date,n=(a.getHours()<10?"0"+a.getHours():a.getHours())+":"+(a.getMinutes()<10?"0"+a.getMinutes():a.getMinutes())+":"+(a.getSeconds()<10?"0"+a.getSeconds():a.getSeconds());SetSaveMessage("Saved! Your URL is <br><a href="+t+">"+t+"</a><br>Bookmark or share this link to access your saved machine.<br><span style='font-size: small; font-style: italic;'>Last saved at "+n+"</span>",1)}else debug(1,"Error: Save failed. Missing data or id from Github response."),SetSaveMessage("Save failed, sorry :(",2)}function saveErrorCallback(e,t,a){debug(1,"Error: Save failed. AJAX request to Github failed. HTTP response "+a.status+" "+a.statusText),SetSaveMessage("Save failed, sorry :(",2)}function SetSaveMessage(e,t){$("#SaveStatusMsg").html(e),$("#SaveStatus").slideDown(),t&&$("#SaveStatusBg").stop(!0,!0).css("background-color",1==t?"#88ee99":"#eb8888").show().fadeOut(800)}function ClearSaveMessage(){$("#SaveStatusMsg").empty(),$("#SaveStatus").hide()}function LoadSampleProgram(e,t,a){debug(1,"Load '"+e+"'"),SetStatusMessage("Chargement du programme d'exemple...");var n="machines/"+e+".txt";StopTimer(),$.ajax({url:n,type:"GET",dataType:"text",success:function(e,n,r){var s=new RegExp(";.*\\$INITIAL_TAPE:? *(.+)$"),o=s.exec(e);null!=o&&o.length>=2&&(debug(4,"Parsed initial tape: '"+o+"' length: "+(null==o?"null":o.length)),$("#InitialInput")[0].value=o[1]),$("#InitialState")[0].value="q0",nVariant=0,$("#MachineVariant").val(0),VariantChanged(),oTextarea.value=e,TextareaChanged(),Compile(),Reset(),a||(SetStatusMessage(t+" bien chargée",1),notifyUser(t+" bien chargée",1))},error:function(e,a,n){debug(1,"Error: Load failed. HTTP response "+n.status+" "+n.statusText),SetStatusMessage("Erreur en chargeant "+t+" :(",2),notifyUser("Erreur en chargeant "+t+" :(",2)}}),$("#LoadMenu").slideUp(),ClearSaveMessage()}function TextareaChanged(){var e=(oTextarea.value.match(/\n/g)?oTextarea.value.match(/\n/g).length:0)+1;e!=nTextareaLines&&(nTextareaLines=e,UpdateTextareaDecorations()),bIsDirty=!0,oPrevInstruction=null,oNextInstruction=null,RenderLineMarkers()}function UpdateTextareaDecorations(){var e=$("#SourceBackground");e.empty();var t=oTextarea.value;t=t.replace(/\r/g,"");for(var a=t.split("\n"),n=0;n<a.length;n++)e.append($("<div id='talinebg"+(n+1)+"' class='talinebg'><div class='talinenum'>"+(n+1)+"</div></div>"));UpdateTextareaScroll()}function SetActiveLines(e,t){$(".talinebgnext").removeClass("talinebgnext"),oNextLineMarker.detach().removeClass("shifted"),$(".talinebgprev").removeClass("talinebgprev"),oPrevLineMarker.detach().removeClass("shifted"),e>=0&&$("#talinebg"+(e+1)).addClass("talinebgnext").prepend(oNextLineMarker),t>=0&&(t!=e?$("#talinebg"+(t+1)).addClass("talinebgprev").prepend(oPrevLineMarker):($("#talinebg"+(t+1)).prepend(oPrevLineMarker),oNextLineMarker.addClass("shifted"),oPrevLineMarker.addClass("shifted")))}function SetErrorLine(e){$("#talinebg"+(e+1)).addClass("talinebgerror")}function ClearErrorLines(){$(".talinebg").removeClass("talinebgerror")}function UpdateTextareaScroll(){var e=$("#SourceBackground");$(e).css({"margin-top":-1*$(oTextarea).scrollTop()+"px"})}function AboutMenuClicked(e){$(".AboutItem").css("font-weight","normal"),$("#AboutItem"+e).css("font-weight","bold"),$(".AboutContent").slideUp({queue:!1,duration:150}).fadeOut(150),$("#AboutContent"+e).stop().detach().prependTo("#AboutContentContainer").fadeIn({queue:!1,duration:150}).css("display","none").slideDown(150)}function OnLoad(){nDebugLevel>0&&$(".DebugClass").toggle(!0),"undefined"!=typeof isOldIE&&(debug(1,"Old version of IE detected, adding extra textarea events"),$("#Source").on("keypress change",TextareaChanged)),oTextarea=$("#Source")[0],TextareaChanged(),VariantChanged(),""!=window.location.search?(SetStatusMessage("Chargement de la machine sauvegardée..."),LoadFromCloud(window.location.search.substring(1)),window.history.replaceState(null,"",window.location.pathname)):(LoadSampleProgram("TP4--Q3-1","TP4 - Q3.1 (ENSAI, 2016)",!0),SetStatusMessage('Chargez un programme avec le menu, ou écrivez le votre, et cliquez sur "Lancer" !'))}function testsave(e){e?saveSuccessCallback({id:"!!!WHACK!!!"+$.now(),url:"http://wha.ck/xxx"}):saveErrorCallback({id:"!!!WHACK!!!"+$.now(),url:"http://wha.ck/xxx"},null,{status:-1,statusText:"dummy"})}function repeat(e,t){for(var a="";t-->0;)a+=e;return a}function debug(e,t){0>=e&&(SetStatusMessage(t),console.log(t)),nDebugLevel>=e&&($("#debug").append(document.createTextNode(t+"\n")),console.log(t))}var nDebugLevel=0,bFullSpeed=!1,bIsReset=!1,sTape="",nTapeOffset=0,nHeadPosition=0,sState="q0",nSteps=0,nVariant=0,hRunTimer=null,aProgram=new Object,nMaxUndo=10,aUndoList=[],nTextareaLines=-1,oTextarea,bIsDirty=!0,oNextLineMarker=$("<div id='NextLineMarker' title='Étape suivante'>Suiv<div id='NextLineMarkerEnd'></div></div>"),oPrevLineMarker=$("<div id='PrevLineMarker' title='Étape précédente'>Préc<div id='PrevLineMarkerEnd'></div></div>"),oPrevInstruction=null,oNextInstruction=null,sPreviousStatusMsg="";